<head>
  <script src="https://igorescobar.github.io/jQuery-Mask-Plugin/js/jquery.mask.min.js"></script>
</head>
<script>
    arr=new Array();
    $(document).ready(function(){
        $('.botao').css({
            float: 'right',
            marginRight: '20px'
        })
        $('.botao input').css({
            borderRadius: '0 0 5px 5px',
            fontWeight: '600',
            //backgroundColor: '#63a9c1',
            color: '#111f46',
            padding: '1px 4px'
        })
        $('form').css({
            //width: '710px'
        })
        $('table tr:odd').css({
            //background: '#ccc'
        })
        $('td img').click(function(){
            if($(this).attr('title')=='Exclui'){
                var razao=$(this).attr('razao');
                var confirma=confirm('Confirma Exclusão de "'+razao+'"');
                if(confirma){
                    var codigo=$(this).attr('codigo');
                    $(location).attr('href','index.php?pagina=produto&act=excl&codigo='+codigo+'')
                }
            }else if($(this).attr('title')=='Altera'){
                var codigo=$(this).attr('codigo');
                $(location).attr('href','index.php?pagina=produto&act=alt&codigo='+codigo+'')
            }
        })
        $('.procura img').mouseover(function(){
            $(this).css('cursor','pointer')
        })
        $('.procura').keyup(function(e){
              var code = e.which; // recommended to use e.which, it's normalized across browsers
              if(code==13)e.preventDefault();
              if(code==13||e.keyCode==13){
                  var codigo=$('.procura :input').val();
                  if(codigo){
                    $(location).attr('href','index.php?pagina=produto&act=cons&codigo='+codigo+'')
                  }
              } 
        })
        $('.procura img').click(function(){
            var codigo=$('.procura :input').val();
              if(codigo){
                $(location).attr('href','index.php?pagina=produto&act=cons&codigo='+codigo+'')
              }
        })
        $('.razaosocial').mouseover(function(){
            $(this).css('cursor','pointer')
            $(this).attr('title','dê um duplo clique para ver detalhes.')
        })
        $('.razaosocial').dblclick(function(){
            var codigo=$(this).attr('linha');
            $(location).attr('href','index.php?pagina=produto&act=cons&codigo='+codigo+'')
        })
        $(':submit').click(function(){
            var arr=new Array();
            $(':input').each(function(){
                arr.push($(this).attr('name'));          
            })
        })
        var pagina=null;
        $('.pagina').text(pag)
            $('#pnl2').css('display','none')          
            $('#pnl3').css('display','none')          
            $('#pnl4').css('display','none')
            $('#pnl5').css('display','none')           
            $('#pnl6').css('display','none')
        $('.outrosItens span').click(function(){
            $('.outrosItens span').css({
                background: 'white'
            });
            $(this).css('background','#ccc');
            $('#pnl1').css('display','none')
            $('#pnl2').css('display','none')          
            $('#pnl3').css('display','none')          
            $('#pnl4').css('display','none')
            $('#pnl5').css('display','none')           
            $('#pnl6').css('display','none')
            if($(this).text()=='Itens de Venda'){
                $('#pnl1').css('display','block')
            }else if($(this).text()=='Frete/Despesas'){
                $('#pnl2').css('display','block')
            }else if($(this).text()=='Informações Adcionais'){
                $('#pnl3').css('display','block')
            }else if($(this).text()=='Parcelas'){
                $('#pnl4').css('display','block')
            }else if($(this).text()=='E-mail'){
                $('#pnl5').css('display','block')
            }else if($(this).text()=='OBS'){
                $('#pnl6').css('display','block')
            }
        })
        $('#botoes .bnt,.outrosItens span').mouseover(function(){
            $(this).css('cursor','pointer')
        })
        var cont=0;
        $('.novo').hide();
        $('#botoes .bnt').click(function(){
            if($(this).text()=='Novo Ítem'){
                $.each(arr,function(){
                    //alert(arr[cont]);
                    cont++;
                })
                $('.novo').show()
                //$('.divVendas').append(text('aqui'))
            }else if($(this).text()=='Editar Ítem'){
                
            }else if($(this).text()=='Excluir Ítem'){
                
            }
        })
        $('.tabela img').click(function(){
            $(location).attr('href','index.php?pagina=cliente&act=list&seleciona=1')
        })
        $('.novo input').each(function(){
            //alert($(this).attr('name'));
            if($(this).attr('name')=='Quantidade'){
                    //$(this).val().maskMoney({symbol:'R$ ',showSymbol:true, thousands:'.', decimal:',', symbolStay: true});
                //$(this).maskMoney('mask', 1999.99);
                $(this).mask('################', {reverse: true});
                var quantidade=$(this).val();
                $(this).keyup(function(){
                    var algarismo1=qEstoque.length;
                    var algarismo2=$(this).val().length;
                    var zero=algarismo1-algarismo2;
                    //alert(zero);
                    switch(zero){
                        case 1:
                            zero='0';
                            break;
                        case 2:
                            zero='00';
                            break;
                        case 3:
                            zero='000';
                            break;
                        default:
                            zero='';
                    }
                    var quantidade=zero+$(this).val();
                    //alert(quantidade);
                    //alert([algarismo,quantidade]);
                    //alert(quantidade > qEstoque);
                    if(quantidade > qEstoque){
                        //alert(quantidade);
                        alert('Quantidade em Estoque '+qEstoque+'');
                        $(this).val(qEstoque);
                    }
                    /*if($.isNumeric($(this).val()){
                        alert($(this).val());
                    }*/
                })
                
                alert(quantidade);
            }
        })
        //alert($('.novo input').attr('name','Quantidade'));
        //alert($('.window').text());
    })
</script>
<style>
    #menu ul {
        padding:0px;
        margin:0px;
        background-color:#EDEDED;
        list-style:none;
        font-size: 20px;
    }
    #menu ul li{
        display: inline;
    }
    .head{
        text-align: center;
        font-size: 25px;
    }
    .pag{
        font-size: 12px;
    }
    .total{
        float: right;
    }
    form{
        width: 710px;
    }
    .tabela{
        //background: rgba(216, 0, 0,0.1);
        padding: 5px;
        font-size: 15px;
        width: 685px;
    }
    .tabela th{
        background: black;
        color: white;
        font-size: 20px;
        padding: 2px;
    }
    .tabela td{
        height: 18px;
    }
    .fTotais{
        border: 2px solid rgba(216, 0, 0,0.1);
        background: rgba(216, 0, 0,0.1);
        border-radius: 5px;
        width: 530px;
    }
    .fTotais table{
        margin: auto;
        font-size: 13px;
    }
    .fTotais table td{
        padding: 5px;
    }
    fieldset legend{
        font-size: 15px;
    }
    .divVendas{
        //border: solid black;
        width: 710px;
        height: 200px;
        overflow: auto;
        margin-top: 10px;
    }
    .divVendas table{
        width: 900px;
        white-space: nowrap;
    }
    .divVendas table td{
        font-size: 10px;
        //border: solid red;
        padding: 0 5px;
    }
    .iVendas{
        //border: solid #ccc;
        height: 170px;
    }
    .outrosItens span{
        padding: 2px 20px;
    }
    .outrosItens .item{
        background: #ccc;
    }
    #botoes{
        margin-top: 10px;
    }
    #botoes .bnt{
        margin: 5px;
        background: orange;
        color: white;
        padding: 0 5px;
    }
    .rs{
        width: 70%;
    }
    .ct{
        align-content: center;
    }
    .edicao{
        background-color: white;
        padding: 0;
    }
    td img:hover{
        cursor: pointer;
    }
    .procura{
        float: right;
        margin: 10px;
    }
    .procura img{
        margin-top: 2px;
    }
    .valores{
        background: #ccc;
    }
</style>
<div id="menu">
    <ul>
        <li><a href=<?= Utils::createLink('pedido',array('act'=>'cad')); ?>>Incluir</a></li>
        <li><a href=<?= Utils::createLink('pedido',array('act'=>'list')); ?>>Listar</a></li>
    </ul>
    <?php if($act!='cad'){?>
    <div class="procura"><input autofocus type="text" name="procura" title="Pesquisar por produtos" /> <img height="18px" src="../web/img/lupa.png" title="Pesquisar por produtos" /></div>
    <?php } ?>
    <script>var pag="PRÉ-VENDA";</script>
</div>
<div class="conteudo">
<?php if($act=='cad'): ?>
<h1>Inclusão de Pedido de Venda</h1>
<form method="post" action="../paginas/add.php?act=cad&pagina=pedido" >
<?php
$json='stdClass Object ( [cabecalho] => stdClass Object ( [bloqueado] => N [codigo_cliente] => 3792227 [codigo_pedido_integracao] => 1518658537 [data_previsao] => 14/02/2018 [etapa] => 50 [numero_pedido] => 68319 [quantidade_itens] => 1 ) '
        . '[det] => Array ( [0] => stdClass Object ( [ide] => stdClass Object ( [codigo_item_integracao] => 4422421 [simples_nacional] => S ) [imposto] => stdClass Object ( [cofins_padrao] => stdClass Object ( [aliq_cofins] => 3 [base_cofins] => 400 [cod_sit_trib_cofins] => 01 [tipo_calculo_cofins] => B [valor_cofins] => 12 ) [icms_sn] => stdClass Object ( [aliq_icms_sn] => 1.25 [cod_sit_trib_icms_sn] => 101 [origem_icms_sn] => 0 [valor_credito_icms_sn] => 5 ) [ipi] => stdClass Object ( [cod_sit_trib_ipi] => 51 ) [pis_padrao] => stdClass Object ( [aliq_pis] => 0.65 [base_pis] => 400 [cod_sit_trib_pis] => 01 [tipo_calculo_pis] => B [valor_pis] => 2.6 ) ) [inf_adic] => stdClass Object ( [peso_bruto] => 150 [peso_liquido] => 150 ) [produto] => stdClass Object ( [cfop] => 5.102 [codigo_produto] => 4422421 [descricao] => Telefone Celular X [ncm] => 9403.30.00 [quantidade] => 1 [tipo_desconto] => V [unidade] => UN [valor_desconto] => 0 [valor_mercadoria] => 200 [valor_total] => 200 [valor_unitario] => 200 ) ) ) [frete] => stdClass Object ( [codigo_transportadora] => 2239663 [modalidade] => 1 [placa] => ABC1234 [placa_estado] => SP [valor_frete] => 30 ) [informacoes_adicionais] => stdClass Object ( [codigo_categoria] => 1.01.03 [codigo_conta_corrente] => 11850365 [consumidor_final] => S [enviar_email] => N ) [lista_parcelas] => stdClass Object ( [parcela] => Array ( [0] => stdClass Object ( [data_vencimento] => 15/02/2018 [numero_parcela] => 1 [percentual] => 50 [valor] => 100 ) [1] => stdClass Object ( [data_vencimento] => 22/05/2018 [numero_parcela] => 2 [percentual] => 50 [valor] => 100 ) ) ) [total_pedido] => stdClass Object ( [base_calculo_icms] => 200 [valor_mercadorias] => 200 [valor_total_pedido] => 200 ) )';
    $variaveis1=array('mercadorias'=>'Mercadorias','desconto'=>'Desconto','ipi'=>'IPI','icms'=>'ICMS ST','vPedido'=>'Valor do Pedido');//valores preenchidos automaticamente
    $variaveis2=array(
                        'Ítens de Venda'=>array(
                            'Código','Descrição do Produto','Quantidade','Preço Unitário de Venda','Valor Total do Ítem','Desconto','ICMS','ICMS ST','IPI','PIS','COFINS','Frete','Seguros','Outras Despesas','ICMS Desonerado','Gera Conta a Receber','Peso Líquido(Kg)','Peso Bruto(Kg)','CFOP'
                        ),
                        'Frete e Outras Despesas'=>array(
                            'Transportadora','Tipo do Frete','Placa do Veícula','UF','RNTRC (ANTT)','Quantidade de Volumes','Espécie dos Volumes','Marca dos Volumes','Numeração dos Volumes','Peso Líquido (Kg)','Peso Bruto (Kg)','Valor do Frete','Valor do Seguro','Número do Lacre','Outras Despesas Acessórias','O transporte será realizado com veículo próprio'
                        ),
                        'Informações Adcionais'=>array(
                            'Categoria','Conta Corrente','Etapa','Nº do Pedido do Cliente','Nº do Contrato de Venda','Contato','Projeto','Dados Adicionais para a Nota Fiscal','Nota Fiscal para Consumo Final'
                        ),
                        'Parcelas'=>array(
                            'Valor Total a Receber','Vencimento da Parcela','Valor da Parcela','Percentual da Parcela','Não gerar boleto desta parcela'
                        ),
                        'E-mail para o Cliente'=>array(
                            'Utilizar os seguintes endereço de e-mail','Enviar o e-mail com o boleto de cobrança gerado pelo faturamento (juntamente com o DANFE e o XML da NFe)'
                        ),
                        'Observações'=>array(
                          'Preencha aqui as observações desta venda (elas não serão exibidas na Nota Fiscal)'  
                        )
        );
?>
<table class="tabela">
    <tr><td colspan="4">Cliente</td><td align="center">Previsão Faturamento</td></tr>
    <tr><td colspan="4"><input name="cliente" type="text" size=65 value="<?= $razao ?>" required> <img src="../web/img/lupa.png" height="14px" title="Pesquisar cliente"/> </td><td><input name="previsao" type="date" value="<?= date('d/m/Y') ?>" /></td></tr>
    <tr><td><font size=2px>CNPJ/CPF</font></td><tr>
    <tr><td><input type="text" name="cnpj_cpf" value="<?= $cnpj_cpf ?>"/></td></tr>
</table>
<fieldset class="fTotais">
    <legend> Totais </legend>
<table>
    <tr>
        <?php foreach($variaveis1 as $key => $item): ?>
            <?php if($item=='IPI'||$item=='ICMS ST'||$item=='Desconto'): ?>
                <td width="20%" align="right"><?= $item ?> </td>
            <?php elseif($item=='Valor do Pedido'): ?>
                <td align="center" ><?= $item ?> </td>
            <?php else: ?>
                <td><?= $item ?></td>
            <?php endif ?>
        <?php endforeach; ?>
    </tr>
    <tr>       
        <?php foreach($variaveis1 as $key => $item): ?>
        <td class="valores" align="right">0,00 </td>
        <?php endforeach; ?>
    </tr>
</table></fieldset>
<table class="tabela">
    <tr><td>Vendedor</td><td>Número de Parcelas</td><td></td></tr>
    <tr><td><input name="vendedor" type="text" ></td><td><input name="parcelas" type="text" /></td></tr>
</table>
    <div class="outrosItens">
        <span class="item">Itens de Venda</span>
        <span class="frete">Frete/Despesas</span>
        <span class="info">Informações Adcionais</span>
        <span class="parcela">Parcelas</span>        
        <span class="email">E-mail</span>
        <span class="observacao">OBS</span>
    </div>
        <div id='pnl1'>
            <div id='botoes'>
                <span class='bnt'>Novo Ítem</span><span class='bnt'>Editar Ítem</span><span class='bnt'>Excluir Ítem</span>
            </div>
            <div class="divVendas dItem">
        <!--<fieldset class="iVendas">-->
                <table>
                    <tr>
                    <?php $ref=1; ?>
                    <?php foreach($variaveis2['Ítens de Venda'] as $key => $item): ?>
                    <td><?= $item ?></td>
                    <script>arr.push('<?=$item?>')</script>
                    <?php endforeach; ?>
                    </tr>
                    <tr class='novo'>
                    <?php foreach($variaveis2['Ítens de Venda'] as $key => $item): ?>
                        <td><input type='text' name='<?= $item ?>' /></td>
                    <?php $ref++; endforeach; ?>
                    </tr>
                </table>
        <!--</fieldset>-->
            </div>
        </div>
        <div id='pnl2'>
            <div class="divVendas dItem">
        <!--<fieldset class="iVendas">-->
                <table>
                    <tr>
                    <?php foreach($variaveis2['Frete e Outras Despesas'] as $key => $item): ?>
                    <td><?= $item ?></td>
                    <?php endforeach; ?>
                    </tr>
                </table>
        <!--</fieldset>-->
            </div>
        </div>
        <div id='pnl3'>
            <div class="divVendas dItem">
        <!--<fieldset class="iVendas">-->
                <table>
                    <tr>
                    <?php foreach($variaveis2['Informações Adcionais'] as $key => $item): ?>
                    <td><?= $item ?></td>
                    <?php endforeach; ?>
                    </tr>
                </table>
        <!--</fieldset>-->
            </div>
        </div>
        <div id='pnl4'>
            <div class="divVendas dItem">
        <!--<fieldset class="iVendas">-->
                <table>
                    <tr>
                    <?php foreach($variaveis2['Parcelas'] as $key => $item): ?>
                    <td><?= $item ?></td>
                    <?php endforeach; ?>
                    </tr>
                </table>
        <!--</fieldset>-->
            </div>
        </div>
        <div id='pnl5'>
            <div class="divVendas dItem">
        <!--<fieldset class="iVendas">-->
                <table>
                    <tr>
                    <?php foreach($variaveis2['E-mail para o Cliente'] as $key => $item): ?>
                    <td><?= $item ?></td>
                    <?php endforeach; ?>
                    </tr>
                </table>
        <!--</fieldset>-->
            </div>
        </div>
        <div id='pnl6'>
            <div class="divVendas dItem">
        <!--<fieldset class="iVendas">-->
                <table>
                    <tr>
                    <?php foreach($variaveis2['Observações'] as $key => $item): ?>
                    <td><?= $item ?></td>
                    <?php endforeach; ?>
                    </tr>
                </table>
        <!--</fieldset>-->
            </div>
        </div>
    <div class="botao">
    <input type="reset" value="Limpa"/>
    <input type="submit" value="Confirma"/>
</div>
<div id="painel"></div>
</form>
<?php elseif($act=='cons'):?>

<?php elseif($act=='alt'): ?>

<?php elseif($act=='list'): ?>


<?php else: 
    $pvpListarRequest=array("pagina"=>1,"registros_por_pagina"=>50,"apenas_importado_api"=>"N");
    $dados=$pedido->ListarPedidos($pvpListarRequest);
    //echo '<pre>';
    //print_r($dados->pedido_venda_produto[3]);
    $posicao=array('Pedido de Venda','Separar Estoque','Faturar','Faturado','Entrega');
    foreach($dados->pedido_venda_produto as $key => $item){
            if($item->cabecalho->etapa=='10'){
                $triagem['Pedido de Venda']=$item->cabecalho;
            }elseif($item->cabecalho->etapa=='20'){
                $triagem['Separar Estoque']=$item->cabecalho;
            }elseif($item->cabecalho->etapa=='50'){
                $triagem['Faturar']=$item->cabecalho;
            }elseif($item->cabecalho->etapa=='60'){
                $triagem['Faturado']=$item->cabecalho;
            }elseif($item->cabecalho->etapa=='70'){
                $triagem['Entrega']=$item->cabecalho;
            }
    }
     $clientes_cadastro_chave=array("codigo_cliente_omie"=>0,"codigo_cliente_integracao"=>"");    
    echo '<ul>';
    $y=1;
    foreach($posicao as $item){
        echo '<ul><li>';
            echo $item;
                echo '<ul>';
                if(@$triagem[$item]->numero_pedido){
                    echo '<li>Pedido Nº'.number_format($triagem[$item]->numero_pedido);
                    switch($y){
                        case 1:
                            echo ' <select name=etapa>';
                                echo '<option value=1></option>';
                                echo '<option value=1>2</option>';
                                echo '<option value=1>3</option>';
                                echo '<option value=1>4</option>';
                                echo '<option value=1>5</option>';
                            echo '</select>';
                            break;
                        case 2:
                            echo ' <select name=etapa>';
                                echo '<option value=2></option>';
                                echo '<option value=2>1</option>';
                                echo '<option value=2>3</option>';
                                echo '<option value=2>4</option>';
                                echo '<option value=2>5</option>';
                            echo '</select>';
                            break;
                        case 3:
                            echo ' <select name=etapa>';
                                echo '<option value=3></option>';
                                echo '<option value=3>1</option>';
                                echo '<option value=3>2</option>';
                                echo '<option value=3>4</option>';
                                echo '<option value=3>5</option>';
                            echo '</select>';
                            break;
                        case 4:
                            echo ' <select name=etapa>';
                                echo '<option value=4></option>';
                                echo '<option value=4>5</option>';
                            echo '</select>';
                            break;
                        case 5:
                            echo ' <select name=etapa>';
                                echo '<option value=5></option>';
                                echo '<option value=5>4</option>';
                            echo '</select>';
                            break;
                    }
                    echo ' Alterar Etapa</li>';
                    $clientes_cadastro_chave=array('codigo_cliente_omie'=>$triagem[$item]->codigo_cliente);
                    $dados_cliente=$cliente->ConsultarCliente($clientes_cadastro_chave);
                    echo '<li><b>'.$dados_cliente->nome_fantasia.'</b></li>';
                    $prev=Utils::datafatura($triagem[$item]->data_previsao,$triagem[$item]->etapa);
                    $cor=substr(strstr($prev,','),1);
                    $fatura=strstr($prev,',',true);
                    //print_r($);
                    echo '<li><font color='.$cor.'>'.$fatura.'</font></li>';
                }
                echo '</ul>';
        echo '</li></ul>';
        $y++;
    }
    echo '</ul>';
?>
<?php endif; ?>
</div>