<html>
<head>
  <script src="https://igorescobar.github.io/jQuery-Mask-Plugin/js/jquery.mask.min.js"></script>
<script>
    arr=new Array();
    $(document).ready(function(){
        $('.botao :reset').trigger('click')
        $('.botao input').mouseover(function(){
            $(this).css('cursor','pointer')
        })
        //$('body').css('background','rgba(100,200,100,0.1)')
        $('.botao').css({
            float: 'left',
            marginTop: '4px',
            marginLeft: '745px'
        })
        $('.botao input').css({
            borderRadius: '0 0 5px 5px',
            fontWeight: '600',
            color: '#111f46',
            padding: '1px 4px'
        })
        
        $('#botoes .bnt,.outrosItens span').mouseover(function(){
            $(this).css('cursor','pointer')
        })  
        var item=1;
        var conf=null;
        var conf2=null;
        $('#botoes .bnt').click(function(){
            if(!$('.razao input').val()){
                alert('Preenche campo "CLIENTE"');
                $('.razao input').focus();
                return false;
            }else if(!$('.cnpj input').val()){
                alert('Preenche campo "CNPJ/CPF"');
                $('.cnpj input').focus();
                return false;
            }             
            if($(this).text()=='Novo Ítem'){
                if(!$('#pnl1 table input[name=codigo_produto'+item+']').val()){
                    alert('Não foi inserido nenhum dado no NOVO ÍTEM.');
                    $('#pnl1 table input[name=codigo_produto'+item+']').css('background','rgba(216, 0, 0,0.1)').focus()
                    die;
                }
                /*$('#pnl1 table input').each(function(){
                    var str=$(this).attr('name');
                    if(str.substr(0,str.length-1)=='codigo_produto'){
                        alert([y,item]);
                        if(y==item){
                            if(!$(this).val()){
                                alert('Não foi inserido nenhum dado no NOVO ÍTEM.');
                                $(this).css('background','rgba(216, 0, 0,0.1)')
                                $(this).focus();
                                die;
                            }
                        }
                        y++;
                    }
                })*/
                item++;//alert(item);
                //if($('#pnl1 table span').length != 0){
                   $('#pnl1 table').append('<tr id=item'+item+'><span class=novo><td class="lupa" ></td><td class=item>'+item+'</td><td><input type="text" name="codigo_produto'+item+'" linha='+item+' required/></td><td><input type="text" name="descricao'+item+'" /></td><td><input type="text" name="quantidade'+item+'" autocomplete="off" required linha='+item+' /></td><td><input type="text" name="vUnitarioItem'+item+'" /></td><td><input type="text" name="vTotalItem'+item+'" linha='+item+' disabled /></td><td><input type="text" name="pDescontoItem'+item+'" linha='+item+' /></td><td><input type="text" name="obs_item'+item+'" linha='+item+' /></td><td><input type="text" name="cfop'+item+'" linha='+item+' /></td><td><input type="text" name="ncm'+item+'" linha='+item+' /></td><td><input type="text" name="ean'+item+'" linha='+item+' /></td><td><input type="text" name="unidade'+item+'" linha='+item+' /></td><!--<td><select name=loja'+item+' ><option value=loja1>Loja 1</option><option value=loja2>Loja 2</option></select></td>--><td><input type="hidden" name="vTotalItem'+item+'" linha='+item+' /></td></span></tr>')
                    itemExclusao();
                    busca();
                    $('#pnl1 table input[name=codigo_produto'+item+']').trigger('focus')
                    //quadroInferior();
                //}else{
                    //$('#pnl1 table').append('<tr id=item'+item+'><span class=novo><td class=lupa></td><td class=item>'+item+'</td><td><input type="text" name="codigo_produto'+item+'" linha='+item+' required/></td><td><input type="text" name="descricao'+item+'" /></td><td><input type="text" name="quantidade'+item+'" autocomplete="off" linha='+item+' required /></td><td><input type="text" name="vUnitarioItem'+item+'" /></td><td><input type="text" name="vTotalItem'+item+'" linha='+item+' disabled /></td><td><input type="text" name="pDescontoItem'+item+'" linha='+item+' /></td><td><input type="text" name="obs_item'+item+'" linha='+item+' /></td><td><input type="text" name="cfop'+item+'" linha='+item+' /></td><td><input type="text" name="ncm'+item+'" linha='+item+' /></td><td><input type="text" name="ean'+item+'" linha='+item+' /></td><td><input type="text" name="unidade'+item+'" linha='+item+' /></td><!--<td><select name=loja'+item+' ><option value=loja1>Loja 1</option><option value=loja2>Loja 2</option></select></td>--><td><input type="hidden" name="vTotalItem'+item+'" linha='+item+' /></td></span></tr>')  
                    //busca();
                    //quadroInferior();
               // }
            }else if($(this).text()=='Excluir Ítem'){
                if($('#pnl1 table input').val()){
                    alert('Clique no Nº do Ítem para excluir.');
                    if(!conf){
                        itemExclusao();
                    }
                }
            }
        })
        busca();
        $('#pnl1 table input[name=codigo_produto'+item+']').trigger('focus')
        $('#pnl2').css('display','none')          
        $('#pnl3').css('display','none')          
        $('#pnl4').css('display','none')
        $('#pnl5').css('display','none')           
        $('#pnl6').css('display','none')
       
        $('.outrosItens span').click(function(){
            $(this).css({
                position: 'relative',
                top: '1px',
                boxShadow: 'none',
                background: '#b1aea1',
                color: 'white',
                textShadow: '2px 2px 2px black'
            });
            var bntAtual=$(this).attr('class');
            $('.outrosItens span').each(function(){
                if(!$(this).hasClass(bntAtual)){
                    $(this).css({
                        position: 'relative',
                        top: '-1px',
                        background: '#d4d2c1',
                        boxShadow: '0 2px 0 gray',
                        textShadow: '2px 2px 2px white',
                        color: 'black'
                    })
                }
            })
            $('#pnl1, #pnl2, #pnl3, #pnl4, #pnl5, #pnl6').css('display','none')
            if($(this).text()=='Itens de Venda'){
                $('#pnl1').css('display','block')
            }else if($(this).text()=='Frete/Despesas'){
                $('#pnl2').css('display','block')
            }else if($(this).text()=='Informações Adcionais'){
                $('#pnl3').css('display','block')
            }else if($(this).text()=='Parcelas'){
                $('#pnl4').css('display','block')
                $('.tabela select[name=parcela]').removeAttr('disabled')
            }else if($(this).text()=='E-mail para Cliente'){
                $('#pnl5').css('display','block')
            }else if($(this).text()=='Observação'){
                $('#pnl6').css('display','block')
            }           
        })
        $('.pagina').text('PRÉ-VENDA')
        $('.tabela img').click(function(){
            if($('#pnl1 input').val()){
                var resp=confirm('Você já adcionou itens a este pedido, estes dados serão descartados. Deseja continuar?');
                if(resp){
                    $(location).attr('href','index.php?pagina=cliente&act=list&seleciona=1&pagAtual=1')
                }else{
                    return false;
                }
            }else{
                $(location).attr('href','index.php?pagina=cliente&act=list&seleciona=1&pagAtual=1')
            }
        })
        $(document).keyup(function(e){
            if(e.which==113){
                if($('form').hasClass('#pnl1') || $('#pnl1 input').val()){
                    var resp=confirm('Você já adcionou itens a este pedido, estes dados serão descartados. Deseja continuar?');
                    if(resp){
                        $(location).attr('href','index.php?pagina=cliente&act=list&seleciona=1&pagAtual=1')
                    }else{
                        return false;
                    }
                }else{
                    $(location).attr('href','index.php?pagina=cliente&act=list&seleciona=1&pagAtual=1')
                }
            }else if(e.which==115){
                $('.bnt').each(function(){
                    if($(this).text()=='Novo Ítem'){
                        $(this).trigger('click')
                        alert($('#pnl1 input').attr('name'));
                    }
                })
                if(!pagAtual){
                    var pagAtual=1;
                }
                link='../paginas/formItem.php?codigo_produto='+codigo_produto+'&pagAtual='+pagAtual+'';
                $('a[rel=modal]').attr('href',link);
                $("a[rel=modal]").trigger("click") 
            }
        })
        $('.previsao input').mask('00/00/0000');
        
        
        $('.tabela td select[name=parcela]').change(function(){
            var selecao=$(this).val().substr(0,2);
            if(selecao=='A '){
                $('#pnl4 .novo4').each(function(){
                    if($(this).attr('linha')>1){
                        $(this).remove()
                    }
                })
                $('#pnl4 .novo4 input[name=numero_parcela1]').val(0)
                $('#pnl4 .novo4 input[name=data_vencimento1]').val($('.tabela input[name=dPrevisao]').val())
                $('#pnl4 .novo4 input[name=valor1]').val($('.autoQuadro td[nome=vPedido]').text())
                $('#pnl4 .novo4 input[name=percentual1]').val(100)
            }else if(selecao=='1 '){
                $('#pnl4 .novo4').each(function(){
                    if($(this).attr('linha')>1){
                        $(this).remove()
                    }
                })
                $('#pnl4 .novo4 input[name=numero_parcela1]').val(1)
                $('#pnl4 .novo4 input[name=data_vencimento1]').val(data(1))
                $('#pnl4 .novo4 input[name=valor1]').val($('.autoQuadro td[nome=vPedido]').text())
                $('#pnl4 .novo4 input[name=percentual1]').val(100)
            }else if(selecao!='Pa' && selecao!='In'){
                $('#pnl4 .novo4').each(function(){
                    if($(this).attr('linha')>1){
                        $(this).remove()
                    }
                })
                var percent=100/selecao;
                for(var x=1;x<parseInt(selecao)+1;x++){
                    if(x!=1){
                        /// adciona nova parcela ///
                        $('#pnl4 table').append($('<tr linha='+x+' class=novo4><td><input size=1px type=text name=numero_parcela'+x+' /></td><td><input size=10px type=text name=data_vencimento'+x+' /></td><td><input size=10px type=text name=valor'+x+' /></td><td><input size=10px type=text name=percentual'+x+' /></td>'))
                    }
                    $('#pnl4 .novo4 input[name=numero_parcela'+x+']').val(x)
                    $('#pnl4 .novo4 input[name=data_vencimento'+x+']').val(data(x))
                    $('#pnl4 .novo4 input[name=valor'+x+']').val(calcula('/',$('.autoQuadro td[nome=vPedido]').text(),selecao))
                    $('#pnl4 .novo4 input[name=percentual'+x+']').val(percent)
                }
            }else if(selecao=='Pa'){
                $('#pnl4 .novo4').each(function(){
                    if($(this).attr('linha')>1){
                        $(this).remove()
                    }
                })
                var now = new Date();
                var numeroMes=new Array('01','02','03','04','05','06','07','08','09','10','11','12','01','02');
                function mesDias(mesDia){
                    switch(mesDia){
                        case 0:
                        case 2:
                        case 4:
                        case 6:
                        case 7:
                        case 9:
                        case 11:
                        case 12:
                            var mesDe=31;
                            break;
                        case 3:
                        case 5:
                        case 8:
                        case 10:
                            var mesDe=30;
                            break;
                        case 1:
                        case 13:
                            var mesDe=28;
                            break;
                    }
                    return mesDe;
                }
                
                
                selecao2=$(this).val().substr(5,2);//,now.getMonth()]);
                if(parseInt(selecao2)+parseInt(now.getDate()) <= mesDias(now.getMonth())){
                    data_vencimento=parseInt(selecao2)+parseInt(now.getDate())+'/'+numeroMes[now.getMonth()]+'/'+now.getFullYear();
                }else if(selecao2-(mesDias(now.getMonth())-now.getDate()) < mesDias(now.getMonth()+1)){
                    var d=selecao2-(mesDias(now.getMonth())-now.getDate());
                    var m=numeroMes[now.getMonth()+1];
                    var a=now.getFullYear();
                    
                    if(now.getMonth()+1 == 12){ /// confere se é dezembro
                        var a=a+1;
                    }
                    
                    data_vencimento=d+'/'+m+'/'+a;
                }else{
                    var d=selecao2-(mesDias(now.getMonth())-now.getDate()) - mesDias(now.getMonth()+1);
                    if(d==0){
                        d='01';
                    }
                    var m=numeroMes[now.getMonth()+2];
                    var a=now.getFullYear();
                    
                    if(now.getMonth()+2 == 12 || now.getMonth()+2 == 13){ /// confere se é dezembro
                        var a=a+1;
                    }
                    
                    data_vencimento=d+'/'+m+'/'+a;
                }
                $('#pnl4 .novo4 input[name=numero_parcela1]').val(1)
                $('#pnl4 .novo4 input[name=data_vencimento1]').val(data_vencimento)
                $('#pnl4 .novo4 input[name=valor1]').val($('.autoQuadro td[nome=vPedido]').text())
                $('#pnl4 .novo4 input[name=percentual1]').val(100)
                
            }
            $('.tabela input[name=dPrevisao]').val($('#pnl4 .novo4 input[name=data_vencimento1]').val())
        })
        $('.tabela td select[name=fPagamento]').change(function(){
            if($(this).val()=='credito' || $(this).val()=='debito'){
                $('.doc').show();
                $('.doc').keyup(function(){
                    var doc=$('.doc input').val();
                    $('#pnl3 table .novo3 input[name=dados_adcionais_nf]').val(doc);
                })
            }else{
                $('.doc').hide();
                $('.doc input').val('');
                $('#pnl3 table .novo3 input[name=dados_adcionais_nf]').val('');
            }
        })
        ///// funcoes ////
        function itemExclusao(){
            var corItem='rgba(255,0,0,0.7)';
            $('#pnl1 table .item').wrap('<span></span>')
            $('#pnl1 table span').css({
                    background: corItem,
                    borderRadius: '10px',
                    boxShadow: '2px 2px 2px gray',
                    color: 'white',
                    textShadow: '1px 1px 1px black',
                    fontWeight: '700'
            }).mouseover(function(){
                $(this).css({
                    cursor: 'pointer',
                    background: '#ccc'
                })
                $(this).mouseleave(function(){
                    $(this).css({
                        background: corItem                                
                    })
                })
                $(this).mousedown(function(){
                    $(this).css({
                        position: 'relative',
                        top: '2px',
                        boxShadow: 'none'
                    }).bind('mouseout mouseup', function(){
                        $(this).css({
                            position: 'relative',
                            top: '-1px',
                            boxShadow: '2px 2px 2px gray'
                        })
                    }).mouseup(function(){
                        if(!conf2 && $('#pnl1 table span').length != 1){
                            if(confirm('Confirma a exclusão do ítem '+$(this).text()+'?')){
                                $('#item'+$(this).text()).remove();
                                $('.autoQuadro td').each(function(){
                                    if($(this).attr('nome')=='tItem'){
                                        $(this).text(item-1);  
                                    }
                                })
                                var z=1;
                                var w=0;
                                $('#pnl1 table .item').each(function(){
                                    $(this).text(z)
                                    z++;
                                });
                                $('#pnl1 table tr').each(function(){
                                   $(this).attr('id','item'+w)
                                   w++;
                                })
                                var z=1;
                                var verifica=($('#pnl1 input').attr('name').substr(-1,1));
                                $('#pnl1 input[name]').each(function(){
                                    nome=$(this).attr('name');
                                    if(nome.substr(-1,1)==verifica){
                                        nome_=nome.substr(0,nome.length-1)+z;
                                        $(this).attr('name',nome_)
                                        $(this).attr('linha',z)
                                    }else{
                                        verifica=nome.substr(-1,1);
                                        z++;
                                        $(this).attr('name',nome.substr(0,nome.length-1)+z)
                                        $(this).attr('linha',z)
                                    }
                                })
                                item=$('#pnl1 table .item').length;
                                conf2=null;
                                $('#pnl1 td input[name=quantidade1]').trigger('click')
                                die;
                            }else{
                                die;
                            }
                        }
                    })
                })
            })
            conf=1;
        }
            //// Cria Busca ////
        function busca(){ 
            $('#pnl1 input').focus(function(){
                var str=$(this).attr('name');
                if(str.substr(0,str.length-1)=='codigo_produto'){
                    $('#pnl1 table .item').each(function(){
                        j=$(this).text();
                    })
                    $('#pnl1 table tr .lupa img').remove();
                    if(!$('#pnl1 table tr .lupa img').attr('src')){
                        $('#pnl1 table tr .lupa').append('<img title="Pesquisar ítem" height=15px src="../web/img/lupa.png" busca='+j+' /> ')
                    }
                }
            })
            quadroInferior();
        }
            //// quadro inferior ////
        function quadroInferior(){
            $('#pnl1 td input').each(function(){
                var str=$(this).attr('name');
                if(str.substr(0,str.length-1)=='quantidade'){
                    $(this).mask('00000');
                    $(this).bind('keyup click', function(){
                        pedLinha=$(this).attr('linha');
                        var algarismo1=qEstoque.length;
                        var algarismo2=$(this).val().length;
                        var zero=algarismo1-algarismo2;
                        switch(zero){
                            case 1:
                                $(this).mask('00');
                                zero='0';
                                break;
                            case 2:
                                $(this).mask('000');
                                zero='00';
                                break;
                            case 3:
                                $(this).mask('0000');
                                zero='000';
                                break;
                            case 4:
                                $(this).mask('00000');
                                zero='0000';
                                break;
                            default:
                                $(this).mask('0');
                                zero='';
                        }
                        quantidade=zero+$(this).val();
                        vUnitarioItem=($('#pnl1 tr[id=item'+pedLinha+'] input[name=vUnitarioItem'+pedLinha+']').val());
                        vTotalItem=calcula('*',vUnitarioItem,quantidade);
                        $($('#pnl1 tr[id=item'+pedLinha+'] input[name=vTotalItem'+pedLinha+  ']')).val(numeroParaMoeda(vTotalItem));
                        qEstoque=$(this).attr('qestoque');
                        if(quantidade > qEstoque){
                            alert('Quantidade em Estoque '+qEstoque+'');
                            vTotalItem=calcula('*',vUnitarioItem,qEstoque);
                            $($('#pnl1 tr[id=item'+pedLinha+'] input[name=vTotalItem'+pedLinha+']')).val(numeroParaMoeda(vTotalItem));
                            $($('#pnl1 tr[id=item'+pedLinha+'] input[name=quantidade'+pedLinha+']')).val(qEstoque);
                            
                        }
                        preencheTotais();
                    })                         
                }else if(str.substr(0,str.length-1)=='pDescontoItem'){
                    $(this).mask('000');
                    $(this).bind('keyup click', function(){
                        if($(this).val()>100){
                            $(this).val(100);
                        }
                        preencheTotais(); 
                    })
                }else if(str.substr(0,str.length-1)=='vUnitarioItem'){
                    $(this).mask('#.###.###,##', {reverse: true})
                    $(this).bind('keyup click', function(){
                        var vlItem=$(this).attr('name');
                        var nBusca=vlItem.substr(vlItem.length-1);
                        $('#pnl1 td input[name=quantidade'+nBusca+']').trigger('click');
                    })
                }
            }) 
        }
        function preencheTotais(){///// preencher quadro com valores Totais ////
                mercadoriaTotal=0;
                vDescontoTotal=0;
                $('#pnl2 .novo2 input[name=qvolume]').val(item)
                $('.autoQuadro input[name=tItem]').val(item)
                $('.autoQuadro td[nome=tItem]').text(item)/// Rotal de Ítens ////
                for(var i=1;i<item+1;i++){
                        mercadoria=$('#pnl1 tr[id=item'+i+'] input[name=vTotalItem'+i+']').val();
                    if(mercadoriaTotal==0){
                        if(mercadoria.charAt(mercadoria.length-3)!='.'){
                            mercadoria=mercadoria.replace('.','');
                        }
                        if(mercadoria.charAt(mercadoria.length-3)==','){
                            mercadoria=mercadoria.replace(',','.');
                        }
                        mercadoriaTotal=mercadoria;
                    }else{
                        mercadoriaTotal=calcula('+',mercadoriaTotal,mercadoria);
                    }
                    var temDesconto=0;
                    $('#pnl1 tr input').each(function(){
                        var h=$(this).attr('name');
                        if(h.substr(0,h.length-1)=='pDescontoItem'){
                            if($(this).val()!=0)temDesconto=1;
                        }
                    })
                    if(temDesconto != 0){
                        mercadoria=$('#pnl1 tr[id=item'+i+'] input[name=vTotalItem'+i+']').val();
                        vDescontoItem=calcula('%',mercadoria,$('#pnl1 tr[id=item'+i+'] input[name=pDescontoItem'+i+']').val());
                        if(vDescontoItem != 'NaN'){
                            vDescontoTotal += parseFloat(vDescontoItem);
                        }
                    }
                }
                if(mercadoriaTotal){
                    $('.autoQuadro input[name=mercadorias]').val(numeroParaMoeda(mercadoriaTotal))
                    $('.autoQuadro td[nome=mercadorias]').text(numeroParaMoeda(mercadoriaTotal)) /// mercadorias ////
                }
                if(vDescontoTotal){
                    $('.autoQuadro input[name=vDesconto]').val(numeroParaMoeda(vDescontoTotal))
                    $('.autoQuadro td[nome=vDesconto]').text(numeroParaMoeda(vDescontoTotal)) /// Desconto ///
                }else{
                    $('.autoQuadro input[name=vDesconto]').val(numeroParaMoeda('0,00'))
                    $('.autoQuadro td[nome=vDesconto]').text(numeroParaMoeda('0,00'))
                }
                var vPedido=calcula('-',$('.autoQuadro td[nome=mercadorias]').text(),$('.autoQuadro td[nome=vDesconto]').text());
                $('.autoQuadro input[name=vPedido]').val(numeroParaMoeda(vPedido))
                $('.autoQuadro td[nome=vPedido]').text(numeroParaMoeda(vPedido)) /// Valor do Pedido ///
        }
    })
    function numeroParaMoeda(n, c, d, t){
        c = isNaN(c = Math.abs(c)) ? 2 : c, d = d == undefined ? "," : d, t = t == undefined ? "." : t, s = n < 0 ? "-" : "", i = parseInt(n = Math.abs(+n || 0).toFixed(c)) + "", j = (j = i.length) > 3 ? j % 3 : 0;
        return s + (j ? i.substr(0, j) + t : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + t) + (c ? d + Math.abs(n - i).toFixed(c).slice(2) : "");    
    }
    function calcula(ope,vl1,vl2){
        if(vl1.charAt(vl1.length-3)!='.'){
            vl1=vl1.replace('.','');
        }
        if(vl2.charAt(vl2.length-3)!='.'){
            vl2=vl2.replace('.','');
        }
        if(vl1.charAt(vl1.length-3)==','){
            vl1=vl1.replace(',','.');
        }
        if(vl2.charAt(vl2.length-3)==','){
            vl2=vl2.replace(',','.');
        }
        switch(ope){
            case '+':
                result=parseFloat(vl1)+parseFloat(vl2);
                break;
            case '-':
                result=parseFloat(vl1)-parseFloat(vl2);
                break;
            case '*':
                result=parseFloat(vl1)*parseFloat(vl2);
                break;
            case '/':
                result=parseFloat(vl1)/parseFloat(vl2);
                break;
            case '%':
                result=parseFloat(vl1)*parseFloat(vl2)/100;
                break;
        }
        return result.toFixed('2');
    }
    function data(fator){
        var fator;
        var now=new Date();
        var numeroMes=new Array('01','02','03','04','05','06','07','08','09','10','11','12');
        m=now.getMonth()+parseInt(fator);
        return now.getDate()+'/'+numeroMes[m]+'/'+now.getFullYear();
    }
</script>
<style>
    body {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }
    #menu ul {
        padding:0px;
        margin:0px;
        background-color:#EDEDED;
        list-style:none;
        font-size: 20px;
    }
    #menu ul li{
        display: inline;
    }
    .head{
        text-align: center;
        font-size: 25px;
    }
    .pag{
        font-size: 12px;
    }
    .total{
        float: right;
    }
    .fPedido{
        width: 980px;
    }
    .tabela{
        padding: 5px;
        font-size: 15px;
        width: 685px;
    }
    .tabela th{
        background: black;
        color: white;
        font-size: 20px;
        padding: 2px;
    }
    .tabela td{
        height: 18px;
    }
    .fTotais{
        border: 2px solid rgba(216, 0, 0,0.1);
        background: rgba(216, 0, 0,0.1);
        border-radius: 5px;
        width: 530px;
    }
    .fTotais table{
        margin: auto;
        font-size: 13px;
    }
    .fTotais table td{
        padding: 5px;
    }
    fieldset legend{
        font-size: 15px;
    }
    .divVendas{
        width: 710px;
        height: 200px;
        overflow: auto;
        margin-top: 10px;
    }
    .divVendas table{
        width: 900px;
        white-space: nowrap;
    }
    .divVendas table td{
        font-size: 10px;
        padding: 0 5px;
    }
    .iVendas{
        height: 170px;
    }
    .outrosItens{
        margin-left: 5px;
        padding: 8px 0;
    }
    .outrosItens span{
        position: relative;
        top: -1px;
        padding: 4px 20px;
        background: #d4d2c1;
        box-shadow: 0 2px 0 gray;
        margin-right: 8px;
        font-weight: 500;
        text-shadow: 2px 2px 2px white;
        border: 1px solid #ccc;
    }
    .outrosItens .item{
        position: relative;
        top: 1px;
        box-shadow: none;
        background: #b1aea1;
        color: white;
        text-shadow: 2px 2px 2px black;
    }
    #botoes{
        margin-top: 10px;
    }
    #botoes .bnt{
        margin: 5px;
        background: orange;
        color: white;
        padding: 3px 8px;
        text-shadow: 1px 1px 1px gray;
        font-weight: 700;
        box-shadow: 2px 2px 2px gray;
    }
    #botoes .bnt:hover{
        background: #c97a08;
    }
    #botoes .bnt:active{
        position: relative;
        top: 3px;
    }
    .rs{
        width: 70%;
    }
    .ct{
        align-content: center;
    }
    .edicao{
        background-color: white;
        padding: 0;
    }
    td img:hover{
        cursor: pointer;
    }
    .procura{
        float: right;
        margin: 10px;
    }
    .procura img{
        margin-top: 2px;
    }
    .valores{
        background: #ccc;
    }
    .conteudo form, .conteudo h1{
        margin-left: 120px;
    }
    .conteudo h1{
        font-size: 38px;
    }
    .doc{
        display: none;
    }
    #pnl2 .divVendas table, #pnl3 .divVendas table, #pnl5 .divVendas table{
        width: 300px;
    }
    #pnl4 .divVendas table{
        width: 100px;
    }
    #pnl4 fieldset{
        padding: 10px 20px;
        overflow-y: scroll;
    }
    #pnl4 .novo4 td{
        font-size: 18px;
    }
    .tecla{
        font-size: 13px;
    }
</style>
</head>
<body>
<div id="menu">
    <ul>
        <!--<li><a href=<?= Utils::createLink('pedido',array('act'=>'cad')); ?>>Incluir</a></li>-->
        <!--<li><a href=<?= Utils::createLink('pedido',array('act'=>'list')); ?>>Listar</a></li>-->
    </ul>
    <?php if($act!='cad'){?>
    <div class="procura"><input autofocus type="text" name="procura" title="Pesquisar por produtos" /> <img height="18px" src="../web/img/lupa.png" title="Pesquisar por produtos" /></div>
    <?php } ?>
</div>
<div class="conteudo">
<?php if($act=='cad'): ?>
<h1>Inclusão de Pedido de Venda</h1>
<form class="fPedido" method="post" action="../paginas/add.php?act=cad&pagina=pedido">
<table class="tabela">
    <tr><td colspan="4">Cliente</td><td align="center">Previsão Faturamento</td></tr>
    <tr><td colspan="4" class="razao"><input type="hidden" name="cCliente" value="<?= $cCliente ?>" /><input name="cliente" type="text" size=53 value="<?= $razao ?>" required /> <img src="../web/img/lupa.png" height="14px" title="Pesquisar cliente"/><span class="tecla"> (F2)</span></td><td class="previsao"><input name="dPrevisao" type="text" value="<?= date('d/m/Y') ?>" /></td></tr>
    <tr><td><font size=2px>CNPJ/CPF</font></td><!--<td>Tabela de Preço</td>--><tr>
    <tr><td class="cnpj"><input type="text" name="cnpj_cpf" value="<?= $cnpj_cpf ?>"/></td>
        <!--<td><select name='cCodIntTabPreco'>   
        </select></td>-->
    </tr>
</table>
<fieldset class="fTotais">
    <legend> Totais </legend>
    <!-- Quadro Preenchido Automaticamente -->
<table>
    <tr>
        <?php foreach($variaveis1 as $key => $item): ?>
            <?php if($item=='IPI'||$item=='ICMS ST'||$item=='Desconto'): ?>
                <td width="20%" align="right"><?= $item ?> </td>
            <?php elseif($item=='Valor do Pedido'): ?>
                <td align="center" ><?= $item ?> </td>
            <?php else: ?>
                <td><?= $item ?></td>
            <?php endif ?>
        <?php endforeach; ?>
    </tr>
    <tr class="autoQuadro">       
        <?php foreach($variaveis1 as $key => $item): ?>
        <?php if($key=='tItem'): ?>
        <td class="valores" nome="<?= $key ?>" align="center">0 </td>
        <input type='hidden' name='<?= $key ?>' value=''/>
        <?php else: ?>
        <td class="valores" nome="<?= $key ?>" vlr="" align="right">0,00 </td>
        <input type='hidden' name='<?= $key ?>' value=''/>
        <?php endif; endforeach; ?>
    </tr>
</table></fieldset>
    <!-- Fim do Quadro -->
<table class="tabela">
    <tr><td>Vendedor</td><td>Número de Parcelas</td><td>Forma de Pagamento</td></tr>
    <tr><td>
            <select name="cod_vend">
                <option value=""></option>
                <?php foreach($vend->cadastro as $key => $item): ?>
                <option value="<?= $item->codigo ?>"><?= $item->nome ?></option>
                <?php endforeach; ?>
            </select>
        </td><td>
            <select name="parcela" disabled>
                <option value=""></option>
                <?php foreach($parcela->cadastros as $key => $item): ?>
                <option value="<?= $item->cDescricao.','.$item->cCodigo.','.$item->nQtdeParc ?>"><?= $item->cDescricao ?></option>
                <?php endforeach; ?>
            </select>
        </td><td>
            <select class='fPag' name="fPagamento">
                <option value=""></option>
                <?php foreach($form_pag as $key => $item): ?>
                <option value="<?= $key ?>"><?= $item ?></option>
                <?php endforeach; ?>
            </select>
        </td>
        <td class='doc'><input type='text' name='doc' placeholder="Isira aqui o documento"/></td></tr>
</table>
    <div class="outrosItens">
        <span class="item">Itens de Venda</span>
        <span class="frete">Frete/Despesas</span>
        <span class="info">Informações Adcionais</span>
        <span class="parcela">Parcelas</span>        
        <span class="email">E-mail para Cliente</span>
        <!--<span class="observacao">Observação</span>-->
    </div>
        <div id='pnl1'>
            <div id='botoes'>
                <span class='bnt'>Novo Ítem</span><span class='bnt'>Excluir Ítem</span><span class='loja'></span>
            </div>
            <div class="divVendas dItem">
        <!--<fieldset class="iVendas">-->
                <table>
                    <tr>
                    <?php //$ref=1; ?>
                    <?php foreach($variaveis2['Ítens de Venda'] as $key => $item): ?>
                        <?php if($item=='Desconto'): ?>
                            <td><?= $item ?>(%)</td>
                        <?php else: ?>
                            <td><?= $item ?></td>
                        <?php endif ?>
                    <?php endforeach; ?>
                    </tr>
                    <tr id=item1><span class=novo><td class=lupa></td><td class=item>1</td><td><input type="text" name="codigo_produto1" linha=1 required/></td><td><input type="text" name="descricao1" /></td><td><input type="text" name="quantidade1" autocomplete="off" linha=1 required /></td><td><input type="text" name="vUnitarioItem1" /></td><td><input type="text" name="vTotalItem1" linha=1 disabled /></td><td><input type="text" name="pDescontoItem1" linha=1 /></td><td><input type="text" name="obs_item1" linha=1 /></td><td><input type="text" name="cfop1" linha=1 /></td><td><input type="text" name="ncm1" linha=1 /></td><td><input type="text" name="ean1" linha=1 /></td><td><input type="text" name="unidade1" linha=1 /></td><!--<td><select name=loja1 ><option value=loja1>Loja 1</option><option value=loja2>Loja 2</option></select></td>--><td><input type="hidden" name="vTotalItem1" linha=1 /></td></span></tr>
                </table>
            </div>
        </div>
        <div id='pnl2'>
            <div class="divVendas dItem">
        <!--<fieldset class="iVendas">-->
                <table>
                    <tr>
                    <?php foreach($variaveis2['Frete e Outras Despesas'] as $key => $item): ?>
                    <td><?= $item ?></td>
                    <?php endforeach; ?>
                    </tr>
                    <tr class='novo2'>
                    <?php foreach($variaveis2['Frete e Outras Despesas'] as $key => $item): ?>
                        <?php if($item == 'Transportadora'){
                            echo '<td width=20px><input size=10px type="text" name="'.$key.'" value="'.$correios->nome_fantasia.'" /></td><input type=hidden name=codigo_transportadora value="'.$correios->codigo_cliente_omie.'" />';
                        }elseif($item == 'Tipo do Frete'){
                            echo '<td width=40px><input size=40px type="text" name="'.$key.'" value="1-Frete por Conta do Destinatário" /></td>';  
                        }elseif($item=='Quantidade de Volumes'){
                            echo "<td><input size=10px type='text' name=$key value='' /></td>";
                        }else{
                            echo '<td><input type="text" name="'.$key.'" /></td>';
                        }
                        endforeach; 
                    ?>
                    </tr>
                </table>
        <!--</fieldset>-->
            </div>
        </div>
        <div id='pnl3'>
            <div class="divVendas dItem">
        <!--<fieldset class="iVendas">-->
                <table>
                    <tr>
                    <?php foreach($variaveis2['Informações Adcionais'] as $key => $item): ?>
                    <td><?= $item ?></td>
                    <?php endforeach; ?>
                    </tr>
                    <tr class='novo3'>
                    <?php foreach($variaveis2['Informações Adcionais'] as $key => $item): ?>
                        <?php if($item=='Categoria'): ?>
                        <td width='8px'><input disabled size=8px type='text' name='<?= $key ?>' value="<?= '1.01.03' ?>"/></td>
                            <input type='hidden' name='<?= $key ?>' value="<?= '1.01.03' ?>"/>
                        <?php elseif($item=='Banco'): ?>
                            <td width=20px><select name='codigo_conta_corrente'>
                            <?php foreach($conta as $key => $item): ?>
                                    <option value='<?= $item->nCodCC ?>'><?= $item->descricao ?></option>
                            <?php endforeach; ?>
                            </td></select>
                        <?php elseif($item=='Etapa'): ?>
                            <td width='20px'><select name='etapa'>
                            <?php 
                                foreach($selEtapa as $key => $item): ?>
                                    <?php if($item->cCodigo!='00'): ?>
                                        <option value='<?= $item->cCodigo ?>'><?= $item->cDescricao ?></option>
                                <?php endif; endforeach; ?>
                            </td></select>
                        <?php elseif($item=='Dados Adicionais para a Nota Fiscal'): ?>                                <td><input size=50px type=text name='dados_adcionais_nf' /></td>
                        <?php endif; ?>
                    <?php /*$ref++;*/ endforeach; ?>
                    </tr>
                </table>
        <!--</fieldset>-->
            </div>
        </div>
        <div id='pnl4'>
            <div class="divVendas dItem">
        <fieldset class="iVendas">
            <legend>Abaixo as parcelas e vencimentos desta venda</legend>
                <table>
                    <tr>
                    <?php foreach($variaveis2['Parcelas'] as $key => $item): ?>
                    <?php if($key!='quantidade_dias'): ?>
                        <td><?= $item ?></td>
                    <?php endif; endforeach; ?>
                    </tr>
                    <tr linha=1 class='novo4'>
                    <?php foreach($variaveis2['Parcelas'] as $key => $item): ?>
                        <?php if($key=='numero_parcela'): ?>
                            <td align='center' width='2px'><input size='1px' type='text' name='<?= $key ?>1' /></td>
                            <!--<input type='hidden' name='<?= $key ?>1' />-->
                        <?php elseif($key=='data_vencimento'): ?>
                            <td align='center' width='7px'><input size='10px' type='text' name='<?= $key ?>1' /></td>
                            <!--<input type='hidden' name='<?= $key ?>1' />-->
                        <?php elseif($key=='valor' || $key=='percentual'): ?>
                            <td align='center' width='7px'><input size='10px' type='text' name='<?= $key ?>1' /></td>
                            <!--<input type='hidden' name='<?= $key ?>1' />-->
                        <?php elseif($key!='quantidade_dias'): ?>
                            <td align='center'><input type='text' name='<?= $key ?>1'  /></td>
                            <!--<input type='hidden' name='<?= $key ?>1' />-->
                        <!--<td><input type='text' name='<?= $key ?>' /></td>-->
                    <?php endif; endforeach; ?>
                    </tr>
                </table>
        </fieldset>
            </div>
        </div>
        <div id='pnl5'>
            <div class="divVendas dItem">
        <!--<fieldset class="iVendas">-->
                <table>
                    <tr>
                    <?php foreach($variaveis2['E-mail para o Cliente'] as $item): ?>
                    <td><?= $item ?></td>
                    <?php endforeach; ?>
                    </tr>
                    <tr>
                        <td><textarea cols="80" name="e-mail"><?= $email ?></textarea></td>
                    </tr>
                </table>
        <!--</fieldset>-->
            </div>
        </div>
        <div id='pnl6'>
            <div class="divVendas dItem">
        <!--<fieldset class="iVendas">-->
                <table>
                    <tr>
                    <?php foreach($variaveis2['Observações'] as $key => $item): ?>
                    <td><?= $item ?></td>
                    <?php endforeach; ?>
                    </tr>
                    <tr>
                        <td><textarea cols="80" name="observacao"></textarea></td>
                    </tr>
                </table>
        <!--</fieldset>-->
            </div>
        </div>
    <span class="botao">
        <input type="hidden" name="dadosProduto" />
        <input type="reset" value="Limpa"/>
        <input type="submit" value="Confirma"/>
    </span>
<div id="painel"></div>
</form>
<?php elseif($act=='cons'):?>

<?php elseif($act=='alt'): ?>

<?php elseif($act=='list'): ?>


<?php else: 
    $pvpListarRequest=array("pagina"=>2,"registros_por_pagina"=>100,"apenas_importado_api"=>"N");
    $dados=$pedido->ListarPedidos($pvpListarRequest);
    
    echo '<pre>';print_r($dados);die;
    
    $posicao=array('Pedido de Venda','Separar Estoque','Faturar','Faturado','Entrega');
    foreach($dados->pedido_venda_produto as $key => $item){
            if($item->cabecalho->etapa=='10'){
                $triagem['Pedido de Venda']=$item->cabecalho;
            }elseif($item->cabecalho->etapa=='20'){
                $triagem['Separar Estoque']=$item->cabecalho;
            }elseif($item->cabecalho->etapa=='50'){
                $triagem['Faturar']=$item->cabecalho;
            }elseif($item->cabecalho->etapa=='60'){
                $triagem['Faturado']=$item->cabecalho;
            }elseif($item->cabecalho->etapa=='70'){
                $triagem['Entrega']=$item->cabecalho;
            }
    }
     $clientes_cadastro_chave=array("codigo_cliente_omie"=>0,"codigo_cliente_integracao"=>"");    
    echo '<ul>';
    $y=1;
    foreach($posicao as $item){
        echo '<ul><li>';
            echo $item;
                echo '<ul>';
                if(@$triagem[$item]->numero_pedido){
                    echo '<li>Pedido Nº'.number_format($triagem[$item]->numero_pedido);
                    switch($y){
                        case 1:
                            echo ' <select name=etapa>';
                                echo '<option value=1></option>';
                                echo '<option value=1>2</option>';
                                echo '<option value=1>3</option>';
                                echo '<option value=1>4</option>';
                                echo '<option value=1>5</option>';
                            echo '</select>';
                            break;
                        case 2:
                            echo ' <select name=etapa>';
                                echo '<option value=2></option>';
                                echo '<option value=2>1</option>';
                                echo '<option value=2>3</option>';
                                echo '<option value=2>4</option>';
                                echo '<option value=2>5</option>';
                            echo '</select>';
                            break;
                        case 3:
                            echo ' <select name=etapa>';
                                echo '<option value=3></option>';
                                echo '<option value=3>1</option>';
                                echo '<option value=3>2</option>';
                                echo '<option value=3>4</option>';
                                echo '<option value=3>5</option>';
                            echo '</select>';
                            break;
                        case 4:
                            echo ' <select name=etapa>';
                                echo '<option value=4></option>';
                                echo '<option value=4>5</option>';
                            echo '</select>';
                            break;
                        case 5:
                            echo ' <select name=etapa>';
                                echo '<option value=5></option>';
                                echo '<option value=5>4</option>';
                            echo '</select>';
                            break;
                    }
                    echo ' Alterar Etapa</li>';
                    $clientes_cadastro_chave=array('codigo_cliente_omie'=>$triagem[$item]->codigo_cliente);
                    $dados_cliente=$cliente->ConsultarCliente($clientes_cadastro_chave);
                    echo '<li><b>'.$dados_cliente->nome_fantasia.'</b></li>';
                    $prev=Utils::datafatura($triagem[$item]->data_previsao,$triagem[$item]->etapa);
                    $cor=substr(strstr($prev,','),1);
                    $fatura=strstr($prev,',',true);
                    //print_r($);
                    echo '<li><font color='.$cor.'>'.$fatura.'</font></li>';
                }
                echo '</ul>';
        echo '</li></ul>';
        $y++;
    }
    echo '</ul>';
?>
<?php endif; ?>
</div>
</body>
</html>